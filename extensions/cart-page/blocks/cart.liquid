{% schema %}
{
  "name": "Fulfillment Selector",
  "target": "section",
  "templates": ["cart"]
}
{% endschema %}
<link rel="stylesheet" href="https://unpkg.com/@shopify/polaris@11.11.0/dist/polaris.css">
<div class="Polaris-Card" style="margin: 20px 0;">
  <div class="Polaris-Card__Section">
    <h2 class="Polaris-Text--root Polaris-Text--headingMd">Choose Fulfillment Mode</h2>
    <div style="margin-top: 15px;">
      <label class="Polaris-Choice">
        <input type="radio" name="fulfillment" value="immediate" class="Polaris-RadioButton__Input">
        <span class="Polaris-Choice__Label">Immediate Shipping</span>
      </label>
      <label class="Polaris-Choice" style="margin-top: 10px; display: block;">
        <input type="radio" name="fulfillment" value="booking" class="Polaris-RadioButton__Input">
        <span class="Polaris-Choice__Label">Booking for Future Shipping</span>
      </label>
    </div>
    <div id="date-wrapper" style="display: none; margin-top: 15px;">
      <p class="Polaris-Text--root Polaris-Text--bodySm">Select Booking Date:</p>
      <input type="date" id="booking-date" class="Polaris-TextField__Input" style="border:1px solid #ccc; padding:5px; border-radius:4px;">
    </div>
  </div>
</div>
<link rel="stylesheet" href="{{ 'date-block.css' | asset_url }}">
<script>
  (async function() {
    console.log("ğŸš€ Fulfillment Selector Loaded");
    const radios = document.querySelectorAll('input[name="fulfillment"]');
    const dateWrapper = document.getElementById('date-wrapper');
    const dateInput = document.getElementById('booking-date');
    console.log("ğŸ“» Radio buttons found:", radios.length);
    console.log("ğŸ›’ Fetching cart...");
    const cart = await fetch('/cart.js').then(res => res.json());
    console.log("ğŸ›’ Cart attributes:", cart.attributes);
    const savedMode = cart.attributes?.fulfillment_mode;
    const savedDate = cart.attributes?.requested_fulfillment_date;
    console.log("ğŸ’¾ Saved fulfillment_mode:", savedMode);
    console.log("ğŸ’¾ Saved requested_fulfillment_date:", savedDate);
    if (savedMode) {
      radios.forEach(radio => {
        radio.checked = radio.value === savedMode;
        console.log(
          `ğŸ”˜ Radio [${radio.value}] checked =`,
          radio.checked
        );
      });
      dateWrapper.style.display =
        savedMode === 'booking' ? 'block' : 'none';
      console.log(
        "ğŸ“… Date picker visible:",
        savedMode === 'booking'
      );
    } else {
      console.log("âš ï¸ No fulfillment_mode found in cart");
    }
    if (savedDate) {
      dateInput.value = savedDate;
      console.log("ğŸ“… Date input prefilled:", savedDate);
    }
    radios.forEach(radio => {
      radio.addEventListener('change', async (e) => {
        const mode = e.target.value;
        console.log("ğŸ”„ User changed mode to:", mode);
        let attributesUpdate = { fulfillment_mode: mode };
        if (mode === 'immediate') {
          dateWrapper.style.display = 'none';
          dateInput.value = '';
          attributesUpdate.requested_fulfillment_date = '';
          console.log("âœ… Immediate selected â†’ date cleared");
        } else {
          dateWrapper.style.display = 'block';
          console.log("â³ Booking selected â†’ waiting for date");
        }
        console.log("â¬†ï¸ Updating cart attributes:", attributesUpdate);
        await fetch('/cart/update.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ attributes: attributesUpdate })
        });
        console.log("âœ… Cart updated successfully");
      });
    });
    dateInput.addEventListener('change', async (e) => {
      const selectedDate = e.target.value;
      console.log("ğŸ“… Date picker changed:", selectedDate);
      if (!selectedDate) {
        console.log("âš ï¸ Empty date, skipping update");
        return;
      }
      await fetch('/cart/update.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          attributes: { requested_fulfillment_date: selectedDate }
        })
      });
      console.log("âœ… Date saved to cart");
    });
  })();
</script>
<style>
.Polaris-Card__Section,
#rep-company-assignment {
Â Â background: #F5F5F5;
Â Â border: 1px solid #E6E8EB;
Â Â border-radius: 14px;
Â Â padding: 20px;
Â Â max-width: 560px;
Â Â margin-bottom: 20px;
Â Â font-family: system-ui, -apple-system, BlinkMacSystemFont;
Â Â box-shadow: 0 1px 0 rgba(0, 0, 0, 0.02);
}

h2.Polaris-Text--root {
Â Â margin-bottom: 14px;
Â Â font-size: 26px;
Â Â font-weight: 600;
Â Â color: #202223;
}

body label.Polaris-Choice {
Â Â Â Â display: flex;
Â Â Â Â align-items: center;
Â Â Â Â gap: 10px;
Â Â Â Â margin-bottom: 0px;
Â Â Â Â font-size: 16px;
Â Â Â Â color: #202223;
Â Â Â Â cursor: pointer;
Â Â Â Â margin-top: 5px ;
}
input.Polaris-RadioButton__Input {
Â Â accent-color: #202223;
}

#date-wrapper {
Â Â margin-top: 16px;
Â Â padding-top: 12px;
Â Â border-top: 1px solid #F1F2F4;
}

input#booking-date {
Â Â height: 36px;
Â Â padding: 0 12px;
Â Â font-size: 17px;
Â Â color: #202223;

Â Â border: 1px solid #C9CCD1;
Â Â border-radius: 8px;
Â Â background-color: #FFFFFF;
Â Â max-width: 100%;

Â Â transition: border-color 0.15s ease, box-shadow 0.15s ease;
}
#date-wrapper p.Polaris-Text--root.Polaris-Text--bodySm {
Â Â Â Â font-size: 16px;
Â Â Â Â font-weight: 500;
Â Â Â Â color: #000;
Â Â Â Â margin-bottom: 6px;
}

#rep-company-assignment p {
Â Â Â Â font-size: 18px;
Â Â Â Â color: #000;
Â Â Â Â margin-bottom: 12px;
}

select#company-selector {
Â Â Â Â padding: 8px 12px;
Â Â Â Â border-radius: 8px;
Â Â Â Â border: 1px solid #C9CCD1;
Â Â Â Â font-size: 17px;
Â Â Â Â background-color: #fff;
}

select#company-selector:focus {
Â Â outline: none;
Â Â border-color: #458FFF;
Â Â box-shadow: 0 0 0 2px rgba(69, 143, 255, 0.2);
}

button#assign-btn {
Â Â Â Â background: #000;
Â Â Â Â color: #FFFFFF;
Â Â Â Â border: none;
Â Â Â Â padding: 8px 16px;
Â Â Â Â border-radius: 8px;
Â Â Â Â cursor: pointer;
Â Â Â Â font-size: 17px;
Â Â Â Â font-weight: 500;
Â Â Â Â transition: background 0.2s ease;
Â Â Â Â margin-left: 10px;
}
button#assign-btn:hover {
Â Â background: #000000;
}

button#assign-btn:active {
Â Â transform: translateY(1px);
}
</style>

