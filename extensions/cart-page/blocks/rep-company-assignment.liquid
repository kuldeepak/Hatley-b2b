<div id="rep-company-assignment" data-customer-id="{{ customer.id }}"></div>

{% if customer %}
<script src="{{ 'rep-company-assignment.js' | asset_url }}" type="module"></script>
<link rel="stylesheet" href="{{ 'rep-company-assignment.css' | asset_url }}">
{% endif %}

{% schema %}
{
  "name": "Company Selector",
  "target": "section",
  "templates": ["cart"]
}
{% endschema %}

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const container = document.getElementById("rep-company-assignment");
  if (!container) return;

  const customerId = container.dataset.customerId;
  if (!customerId) {
    container.innerHTML = "<p>Customer not logged in.</p>";
    return;
  }

  // Helper to fetch data from proxy
  async function proxyFetch(payload) {
    const res = await fetch("/apps/proxy", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!res.ok) throw new Error("Proxy request failed");
    return res.json();
  }

  try {
    // 1️⃣ Fetch current customer company
    const data = await proxyFetch({ customerId, actionType: "fetchCompany" });
    const company = data.company || null;
    const repCode = data.repCode || "";

    if (!company) {
      container.innerHTML = "<p>No company assigned to you.</p>";
      return;
    }

    // 2️⃣ Fetch other companies for this repCode
    const repCompaniesData = await proxyFetch({
      actionType: "fetchRepCompanies",
      repCode,
    });
    const repCompanies = repCompaniesData.companies || [];

    // 3️⃣ Render selector UI
    container.innerHTML = `
      <p>Current Company: <strong>${company.name}</strong></p>
      <select id="company-selector">
        <option value="">-- Select Company --</option>
      </select>
      <button id="assign-btn">Assign to selected company</button>
      <div id="assign-msg"></div>
    `;

    const selector = document.getElementById("company-selector");
    repCompanies
      .filter((c) => c.id !== company.id)
      .forEach((c) => {
        const option = document.createElement("option");
        option.value = c.id;
        option.textContent = c.name;
        selector.appendChild(option);
      });

    // 4️⃣ Handle assign button click
    document.getElementById("assign-btn").addEventListener("click", async () => {
      const newCompanyId = selector.value;
      const msgDiv = document.getElementById("assign-msg");

      if (!newCompanyId) {
        msgDiv.textContent = "Please select a company.";
        msgDiv.style.color = "red";
        return;
      }

      if (newCompanyId === company.id) {
        msgDiv.textContent = "Already assigned to this company.";
        msgDiv.style.color = "orange";
        return;
      }

      try {
        const assignResult = await proxyFetch({
          actionType: "assignCompany",
          customerId,
          companyId: newCompanyId,
        });

        if (assignResult.success) {
          msgDiv.textContent = "Customer reassigned successfully!";
          msgDiv.style.color = "green";
          setTimeout(() => location.reload(), 1000);
        } else {
          msgDiv.textContent = "Error: " + (assignResult.error || "Unknown");
          msgDiv.style.color = "red";
        }
      } catch (err) {
        console.error(err);
        msgDiv.textContent = "Failed to assign customer.";
        msgDiv.style.color = "red";
      }
    });
  } catch (err) {
    console.error(err);
    container.innerHTML = "<p>Failed to load company info.</p>";
  }
});
</script>
<style>
.Polaris-Card__Section,
#rep-company-assignment {
  background: #F5F5F5;
  border: 1px solid #E6E8EB;
  border-radius: 14px;
  padding: 20px;
  max-width: 560px;
  margin-bottom: 20px;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  box-shadow: 0 1px 0 rgba(0, 0, 0, 0.02);
}

h2.Polaris-Text--root {
  margin-bottom: 14px;
  font-size: 26px;
  font-weight: 600;
  color: #202223;
}

body label.Polaris-Choice {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 0px;
    font-size: 16px;
    color: #202223;
    cursor: pointer;
    margin-top: 5px ;
}
input.Polaris-RadioButton__Input {
  accent-color: #202223;
}

#date-wrapper {
  margin-top: 16px;
  padding-top: 12px;
  border-top: 1px solid #F1F2F4;
}

input#booking-date {
  height: 36px;
  padding: 0 12px;
  font-size: 17px;
  color: #202223;

  border: 1px solid #C9CCD1;
  border-radius: 8px;
  background-color: #FFFFFF;
  max-width: 100%;

  transition: border-color 0.15s ease, box-shadow 0.15s ease;
}
#date-wrapper p.Polaris-Text--root.Polaris-Text--bodySm {
    font-size: 16px;
    font-weight: 500;
    color: #000;
    margin-bottom: 6px;
}

#rep-company-assignment p {
    font-size: 18px;
    color: #000;
    margin-bottom: 12px;
}

select#company-selector {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #C9CCD1;
    font-size: 17px;
    background-color: #fff;
}

select#company-selector:focus {
  outline: none;
  border-color: #458FFF;
  box-shadow: 0 0 0 2px rgba(69, 143, 255, 0.2);
}

button#assign-btn {
    background: #000;
    color: #FFFFFF;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 17px;
    font-weight: 500;
    transition: background 0.2s ease;
    margin-left: 10px;
}
button#assign-btn:hover {
  background: #000000;
}

button#assign-btn:active {
  transform: translateY(1px);
}
</style>